<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thống kê Doanh thu</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div th:replace="~{admin/navbar :: navbar}"></div>


<style>
    /* Hiệu ứng hover cho navbar */
    .navbar-nav .nav-link {
        transition: all 0.3s ease-in-out;
        padding: 10px 15px;
        border-radius: 5px;
    }
    .navbar-nav .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.2);
        color: #ffc107 !important;
        transform: scale(1.05);
    }

    /* Làm nổi bật mục active */
    .navbar-nav .nav-item .nav-link.active {
        color: #ffc107 !important;
        font-weight: bold;
        background-color: rgba(255, 255, 255, 0.3);
    }

    /* Hiệu ứng đăng xuất */
    .logout-btn {
        transition: all 0.3s ease-in-out;
    }
    .logout-btn:hover {
        color: white !important;
        background-color: #dc3545;
        transform: scale(1.1);
    }
</style>
</div>
<div class="container mt-4">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">Thống kê</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/admin/revenue/thongke}">Doanh thu</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/admin/revenue/sanphamyeuthich}">Sản phẩm yêu thích</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/admin/revenue/sanphambanchay}">Sản phẩm bán chạy</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    <div class="row">
        <!-- Chọn Năm -->
        <div class="col-md-4">
            <label>Năm</label>
            <select id="yearSelect" class="form-select">
                <option value="">Chọn năm</option>
                <option th:each="year : ${years}" th:value="${year}" th:text="${year}"></option>
            </select>
        </div>

        <!-- Chọn Tháng -->
        <div class="col-md-4">
            <label>Tháng</label>
            <select id="monthSelect" class="form-select" disabled>
                <option value="">Chọn tháng</option>
            </select>
        </div>

        <!-- Chọn Ngày -->
        <div class="col-md-4">
            <label>Ngày</label>
            <select id="daySelect" class="form-select" disabled>
                <option value="">Chọn ngày</option>
            </select>
        </div>
    </div>

    <div class="mt-3">
        <h4>Tổng doanh thu: <span id="totalRevenue">0</span> VNĐ</h4>
    </div>

    <canvas id="revenueChart" height="100"></canvas>
</div>

<script>
    let revenueChart;

    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("yearSelect").addEventListener("change", function() {
            loadMonths();
            fetchRevenueChart();
            fetchRevenue();
        });

        document.getElementById("monthSelect").addEventListener("change", function() {
            loadDays();
            fetchRevenueChart();
            fetchRevenue();
        });

        document.getElementById("daySelect").addEventListener("change", function() {
            fetchRevenueChart();
            fetchRevenue();
        });
    });

    function loadMonths() {
        let year = document.getElementById("yearSelect").value;
        let monthSelect = document.getElementById("monthSelect");
        monthSelect.innerHTML = '<option value="">Chọn tháng</option>';
        document.getElementById("daySelect").innerHTML = '<option value="">Chọn ngày</option>';
        monthSelect.disabled = true;

        if (year) {
            fetch(`/admin/revenue/months/${year}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(month => {
                        let option = document.createElement("option");
                        option.value = month;
                        option.textContent = `Tháng ${month}`;
                        monthSelect.appendChild(option);
                    });
                    monthSelect.disabled = false;
                });
        }
    }

    function loadDays() {
        let year = document.getElementById("yearSelect").value;
        let month = document.getElementById("monthSelect").value;
        let daySelect = document.getElementById("daySelect");
        daySelect.innerHTML = '<option value="">Chọn ngày</option>';
        daySelect.disabled = true;

        if (year && month) {
            fetch(`/admin/revenue/days/${year}/${month}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(day => {
                        let option = document.createElement("option");
                        option.value = day;
                        option.textContent = `Ngày ${day}`;
                        daySelect.appendChild(option);
                    });
                    daySelect.disabled = false;
                });
        }
    }

    function fetchRevenue() {
        let year = document.getElementById("yearSelect").value;
        let month = document.getElementById("monthSelect").value;
        let day = document.getElementById("daySelect").value;

        if (!year) return;

        let url = `/admin/revenue/total/${year}`;
        if (month) url += `/${month}`;
        if (day) url += `/${day}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                document.getElementById("totalRevenue").textContent = data.toLocaleString() + " VNĐ";
            });
    }

    function fetchRevenueChart() {
        let year = document.getElementById("yearSelect").value;
        let month = document.getElementById("monthSelect").value;
        let day = document.getElementById("daySelect").value;

        if (!year) return;

        let url = `/admin/revenue/chart/${year}`;
        if (month) url += `/${month}`;
        if (day) url += `/${day}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (Object.keys(data).length === 0) {
                    return;
                }

                let labels = Object.keys(data);
                let values = Object.values(data);
                let ctx = document.getElementById("revenueChart").getContext("2d");

                if (revenueChart) revenueChart.destroy();

                revenueChart = new Chart(ctx, {
                    type: "line", // Chuyển từ "bar" sang "line"
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Doanh thu (VNĐ)",
                            data: values,
                            backgroundColor: "rgba(54, 162, 235, 0.2)",
                            borderColor: "rgba(54, 162, 235, 1)",
                            borderWidth: 2,
                            pointBackgroundColor: "rgba(54, 162, 235, 1)",
                            pointBorderColor: "#fff",
                            pointRadius: 5,
                            fill: true,
                            tension: 0.3  // Kích thước điểm
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString(); // Format giá trị y-axis
                                    }
                                }
                            }
                        }
                    }
                });
            });
    }

</script>
</body>
</html>
